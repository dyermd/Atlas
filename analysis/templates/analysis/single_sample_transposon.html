{% extends "base.html" %}
{% load staticfiles %}

{% block body %}
<div class="container-fluid">
    <div class="row-fluid" style="padding-top: 25px">
        <div class="hero-unit">
            <h1>Single-sample Transposon Analysis</h1>
            <p>Select a number of input sample files to generate an Excel report.</p>
        </div>
    </div>

    <div id="rootwizard">
        <div class="navbar">
            <div class="navbar-inner">
                <div class="container">
                    <ul>
                        <li><a href="#tab1" data-toggle="tab">Samples</a></li>
                        <li><a href="#tab2" data-toggle="tab">Settings</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <!--
        <div id="bar" class="progress progress-striped active">
            <div class="bar"></div>
        </div>
        -->
        <div class="tab-content">
            <div class="tab-pane" id="tab1">
                <form id="files" name="files">
                    {% if files %}
                        <table id="file_table" class="table display">
                            <thead><tr><th></th><th>Name</th><th>Sample</th><th>Path</th><th>Date</th></tr></thead>
                            <tfoot><tr><th></th><th>Name</th><th>Sample</th><th>Path</th><th>Date</th></tr></tfoot>
                            <tbody>
                                {% for file in files %}
                                    <tr><td><input id="{{ file.id }}" type="checkbox" name="{{ file.file_path }}"></td><td><a href="{% url 'file:detail' file.id %}">{{ file.name }}</a></td><td></td><td>{{ file.file_path }}</td><td>{{ file.date }}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>Currently there are no transposon tab files loaded.</p>
                    {% endif %}
                </form>
            </div>
            <div class="tab-pane" id="tab2">
                <table class="table">
                    <tr><td>Analysis Name:</td><td><input type='text' name='name' id='name' placeholder='Enter a Name'></td></tr>
                    <tr><td>Short Description (Optional):</td><td><input type='text' name='description' id='description' placeholder='Enter a Description'></td></tr>
                    <tr><td>Minimum Read Coverage:</td><td><input type='text' name='read_coverage_minimum' id='read_coverage_minimum' value="50"></td></tr>
                    <tr><td>Minimum Read Size:</td><td><input type='text' name='read_size_minimum' id='read_size_minimum' value="40"></td></tr>
                    <tr><td>Maximum Distance:</td><td><input type='text' name='maximum_distance' id='maximum_distance' value="10000"></td></tr>
                </table>
            </div>

            <ul class="pager wizard">
                <li class="previous"><a href="javascript:;">Previous</a></li>
                <li class="next"><a href="javascript:;">Next</a></li>
                <li class="next finish" style="display:none;"><a href="javascript:;">Finish</a></li>
            </ul>


        </div>
    </div>
</div><!--/.fluid-container-->
{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function() {
            //load the data table
            $('#file_table').dataTable();

            //handle the workflow
            $('#rootwizard').bootstrapWizard({onNext: function (tab, navigation, index) {
                // Set the name for the next tab
                //$('#tab3').html('Hello, ' + $('#name').val());

            }, onTabShow: function (tab, navigation, index) {
                var $total = navigation.find('li').length;
                var $current = index + 1;
                var $percent = ($current / $total) * 100;
                //$('#rootwizard').find('.bar').css({width: $percent + '%'});

                // If it's the last tab then hide the last button and show the finish instead
                if($current >= $total) {
                    $('#rootwizard').find('.pager .next').hide();
                    $('#rootwizard').find('.pager .finish').show();
                    $('#rootwizard').find('.pager .finish').removeClass('disabled');
                } else {
                    $('#rootwizard').find('.pager .next').show();
                    $('#rootwizard').find('.pager .finish').hide();
                }
            }});
        });

        //create a json string from the items in a form
        $.fn.serializeObject = function () {
            var o = {};
            var a = this.serializeArray();
            $.each(a,
                    function () {
                        if (this.name == "file_table_length"){
                            //do nothing
                        }
                        else if (o[this.name] != null) {
                            if (!o[this.name].push) {
                                o[this.name] = [o[this.name]];
                            }
                            o[this.name].push(this.value || '');
                        } else {
                            o[this.name] = this.value || '';
                        }
                    });
            return o;
        };

        $('#rootwizard .finish').click(function() {
            //make sure the user has provided the values we will need
            if (!$('#name').val()) {
                alert('You must enter an analysis name');
                $('#name').focus();
                return false;
            }

            if (!$('#read_coverage_minimum').val()) {
                alert('You must enter a read cutoff');
                $('#read_coverage_minimum').focus();
                return false;
            }

            if (!$('#read_size_minimum').val()) {
                alert('You must enter a minimum read size');
                $('#read_size_minimum').focus();
                return false;
            }

            if (!$('#maximum_distance').val()) {
                alert('You must enter a maximum distance');
                $('#maximum_distance').focus();
                return false;
            }

            //serialize the objects and post to API
            objects =  $('#files').serializeObject();
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth()+1; //January is 0!
            var yyyy = today.getFullYear();
            today = mm+'/'+dd+'/'+yyyy;

            //build the json string
            pluginAPIJSON = {
                "name": $('#name').val(),
                "type": "Transposon Screen",
                "status": "Pending",
                "description": $('#description').val(),
                "date": today,
                "parameters": {
                    "analysis_type": "transposon_single_sample",
                    "settings": {
                        "read_coverage_minimum": $('#read_coverage_minimum').val(),
                        "read_size_minimum": $('#read_size_minimum').val(),
                        "maximum_distance": $('#maximum_distance').val()
                    },
                    "files": objects
                }
            };



            //pluginAPIJSON = { "name" : $('#name').val(), "type" : "Transposon Screen", "analysis_type" : "transposon_single_sample", "status" : "Pending", "date": "June 1 , 2020", "parameters" : obj};
            pluginAPIJSON = JSON.stringify(pluginAPIJSON, null, 2);
            //alert(pluginAPIJSON);
            pluginURL = "/api/v1/analysis/";
            $.ajax({
                type: 'POST',
                url: pluginURL,
                contentType: "application/json; charset=UTF-8",
                data: pluginAPIJSON,
                //dataType: "json",
                success: function (data, textStatus) {
                    window.location.href = "/analysis/";
                },
                error: function(httpObj, txtStatus){
                    alert(httpObj.status + " " + txtStatus);
                }
            });
        });
    </script>
{% endblock %}